<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <title>Actor/Director - TP2 TYGWeb</title>
    <link rel="stylesheet" type="text/css" href="estilos.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <header>
      <h1>TP Nro 2 - Grupo 31</h1>
      <h4>Terruli Tomas, La Gioiosa Bernardita</h4>
    </header>

    <div id="menu">
      <button onclick="cargarDatos()">Cargar datos de APIs</button>
      <button onclick="visualizarDatos()">Visualizar datos</button>
    </div>

    <div id="content">
      <input type="text" id="nombrePersona" placeholder="Ingresá el nombre de una persona..." />
      <button onclick="buscarPersona()">Buscar</button>

      <div id="resultado"></div>
    </div>

    <footer><span>TygWeb Año 2025</span></footer>

    <script>
      const API_KEY = '7ca40bb0f2fb5d7fb8b900779b0e928b';
      const STRAPI_TOKEN = 'Bearer 099da4cc6cbb36bf7af8de6f1f241f8c81e49fce15709c4cfcae1313090fa2c1ac8703b0179863b4eb2739ea65ae435e90999adb870d49f9f94dcadd88999763119edca01a6b34c25be92a80ed30db1bcacb20df40e4e7f45542bd501f059201ad578c18a11e4f5cd592cb25d6c31a054409caa99f11b6d2391440e9c72611ea';
      const STRAPI_URL = 'https://gestionweb.frlp.utn.edu.ar/api/g31-actor-directors';

      let datosParaStrapi = null;

      async function buscarPersona(guardarAutomatico = false) {
        const nombre = document.getElementById('nombrePersona').value.trim();
        const resultadoDiv = document.getElementById('resultado');

        resultadoDiv.innerHTML = '';
        resultadoDiv.style.display = '';          // Resetear estilo del elemento #resultado

        datosParaStrapi = null;

        if (!nombre) {
          resultadoDiv.textContent = 'Por favor ingresá un nombre.';
          return;
        }

        try {
          const searchRes = await fetch(`https://api.themoviedb.org/3/search/person?api_key=${API_KEY}&query=${encodeURIComponent(nombre)}`);
          const searchData = await searchRes.json();

          if (!searchData.results || searchData.results.length === 0) {
            resultadoDiv.textContent = 'Persona no encontrada.';
            return;
          }

          const persona = searchData.results[0];
          const personId = persona.id;

          const creditsRes = await fetch(`https://api.themoviedb.org/3/person/${personId}/combined_credits?api_key=${API_KEY}`);
          const creditsData = await creditsRes.json();

          const actuadas = creditsData.cast || [];
          const dirigidas = (creditsData.crew || []).filter(c => c.job === 'Director');

          if (dirigidas.length === 0) {
            resultadoDiv.innerHTML = `<p><strong>${persona.name}</strong> no fue director/a de ninguna película.</p>`;
            return;
          }

          if (actuadas.length === 0) {
            resultadoDiv.innerHTML = `<p><strong>${persona.name}</strong> fue director/a, pero no actuó en ninguna película.</p>`;
            return;
          }

          const lista = document.createElement('ul');
          const titulos = actuadas.map(p => `${p.title || p.name} (${p.release_date?.slice(0, 4) || 's/f'})`);
          titulos.forEach(titulo => {
            const li = document.createElement('li');
            li.textContent = titulo;
            lista.appendChild(li);
          });

          resultadoDiv.innerHTML = `<p><strong>${persona.name}</strong> fue actor/actriz y también director/a. Películas donde actuó:</p>`;
          resultadoDiv.appendChild(lista);

          datosParaStrapi = {
            nombre: persona.name,
            tmdb_id: personId,
            cant_peliculas: actuadas.length,
            peliculas_actuadas: titulos
          };

          if (guardarAutomatico) {
            guardarEnStrapi(true);
          }

        } catch (err) {
          console.error(err);
          resultadoDiv.textContent = 'Ocurrió un error al buscar la persona.';
        }
      }

      async function guardarEnStrapi(silencioso = false) {
        if (!datosParaStrapi) return;

        try {
          const res = await fetch(STRAPI_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': STRAPI_TOKEN
            },
            body: JSON.stringify({ data: datosParaStrapi })
          });

          if (!res.ok) throw new Error('Error al guardar en Strapi');
          if (!silencioso) alert('Consulta guardada correctamente en Strapi.');
        } catch (err) {
          console.error(err);
          alert('Error al guardar en Strapi.');
        }
      }

      function cargarDatos() {
        buscarPersona(true);
      }

      async function visualizarDatos() {
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.innerHTML = '<p>Cargando datos...</p>';

        try {
          const res = await fetch('https://gestionweb.frlp.utn.edu.ar/api/g31-actor-directors?sort=createdAt:desc&pagination[limit]=100', {
            headers: {
              'Authorization': STRAPI_TOKEN
            }
          });

          const data = await res.json();
          if (!res.ok) throw new Error('Error al obtener datos');

          if (!data.data || data.data.length === 0) {
            resultadoDiv.innerHTML = '<p>No hay consultas guardadas.</p>';
            return;
          }

          const contenedorListado = document.createElement('div');
          contenedorListado.style.flex = '1';
          contenedorListado.style.minWidth = '300px';

          const titulo = document.createElement('h3');
          titulo.textContent = 'Consultas guardadas:';
          contenedorListado.appendChild(titulo);

          const lista = document.createElement('ul');

          data.data.forEach(entry => {
            const item = entry;
            if (!item || !item.nombre || !Array.isArray(item.peliculas_actuadas)) {
              console.warn('Entrada inválida:', entry);
              return;
            }

            const li = document.createElement('li');
            li.innerHTML = `<strong>${item.nombre}</strong> — ${item.cant_peliculas} películas`;

            const pre = document.createElement('pre');
            pre.textContent = item.peliculas_actuadas.join('\n');
            li.appendChild(pre);

            lista.appendChild(li);
          });

          contenedorListado.appendChild(lista);

          resultadoDiv.innerHTML = '';
          resultadoDiv.style.display = 'flex';
          resultadoDiv.style.flexDirection = 'row';
          resultadoDiv.style.gap = '20px';
          resultadoDiv.style.alignItems = 'flex-start';
          resultadoDiv.style.flexWrap = 'wrap';

          resultadoDiv.appendChild(contenedorListado);

          // Gráfico
          const agrupado = {};
          data.data.forEach(entry => {
            const nombre = entry.nombre;
            const cantidad = entry.cant_peliculas;
            if (!agrupado[nombre] || agrupado[nombre] < cantidad) {
              agrupado[nombre] = cantidad;
            }
          });

          const nombres = Object.keys(agrupado).sort((a, b) => agrupado[b] - agrupado[a]);
          const cantidades = nombres.map(nombre => agrupado[nombre]);

          const canvas = document.createElement('canvas');
          canvas.id = 'graficoPeliculas';
          canvas.style.maxWidth = '600px';
          canvas.style.marginTop = '20px';

          resultadoDiv.appendChild(canvas);

          new Chart(canvas, {
            type: 'bar',
            data: {
              labels: nombres,
              datasets: [{
                label: 'Películas actuadas',
                data: cantidades,
                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
              }]
            },
            options: {
              indexAxis: 'y',
              scales: {
                x: {
                  beginAtZero: true
                }
              }
            }
          });

        } catch (err) {
          console.error(err);
          resultadoDiv.innerHTML = '<p>Error al visualizar datos.</p>';
        }
      }
    </script>
  </body>
</html>